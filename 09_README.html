<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>09: Ambiguity and Ordering - MacroKata</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">00: Introduction</a></li><li class="chapter-item expanded "><a href="01_README.html">01: My First Macro</a></li><li class="chapter-item expanded "><a href="02_README.html">02: Numbers</a></li><li class="chapter-item expanded "><a href="03_README.html">03: Literal Meta-Variables</a></li><li class="chapter-item expanded "><a href="04_README.html">04: Expression Meta-Variables</a></li><li class="chapter-item expanded "><a href="05_README.html">05: More Complex Example</a></li><li class="chapter-item expanded "><a href="06_README.html">06: Repetition</a></li><li class="chapter-item expanded "><a href="07_README.html">07: More Repetition</a></li><li class="chapter-item expanded "><a href="08_README.html">08: Nested Repetition</a></li><li class="chapter-item expanded "><a href="09_README.html" class="active">09: Ambiguity and Ordering</a></li><li class="chapter-item expanded "><a href="10_README.html">10: Macros Calling Macros</a></li><li class="chapter-item expanded "><a href="11_README.html">11: Macro Recursion</a></li><li class="chapter-item expanded "><a href="12_README.html">12: Macro Hygiene</a></li><li class="chapter-item expanded "><a href="13_README.html">13: Scoping, Importing and Exporting</a></li><li class="chapter-item expanded "><a href="99_README.html">14: Extra Reading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MacroKata</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="exercise-9-ambiguity-and-ordering"><a class="header" href="#exercise-9-ambiguity-and-ordering">Exercise 9: Ambiguity and Ordering</a></h1>
<p>Up until this point, we've mostly been dealing with macros with a single rule.
We saw earlier that macros can require more than one rule; but so far we've never
had ambiguity in which rule should be followed.</p>
<p>There are, however, multiple circumstances where rules could have ambiguity,
so it's important to understand how macros deal with that ambiguity.</p>
<p>The following is adapted from the <a href="https://doc.rust-lang.org/reference/macros-by-example.html#transcribing">rust documentation on
macros</a>:</p>
<ul>
<li>
<p>When a macro is invoked (i.e. someone writes <code>my_macro!()</code>), the compiler
looks for a macro with that name, and tries each rule in turn.</p>
</li>
<li>
<p>To try a rule, it reads through each token in the parser in turn. There are
three possibilities:</p>
<ol>
<li>The token found matches the matcher. In this case, it keeps parsing the
next token. If there are no tokens left, and the matcher is complete, then
the rule matches.</li>
<li>The token found does not match the matcher. In this case, rust tries the
next rule. If there are no rules left, an error is raised as the macro
cannot be expanded.</li>
<li>The rule is ambiguous. In other words, it's not clear from <em>just this
token</em> what to do. If this happens, this is an error.</li>
</ol>
</li>
<li>
<p>If it finds a rule that matches the tokens inside the brackets; it starts
transcribing. <em>Once a match is found, no more rules are examined</em>.</p>
</li>
</ul>
<p>Let's have a look at some examples:</p>
<pre><code class="language-rust ignore">macro_rules! ambiguity {
    ($($i:ident)* $j:ident) =&gt; { };
}

<span class="boring">fn main() {
</span>ambiguity!(error); 
<span class="boring">}
</span></code></pre>
<p>This example fails because rust is not able to determine what <code>$j</code> should be just by looking at
the current token. If rust could look forward, it would see that <code>$j</code> must be followed by a <code>)</code>,
but it cannot; so it causes an error.</p>
<pre><pre class="playground"><code class="language-rust">macro_rules! ordering {
    ($j:expr) =&gt; { &quot;This was an expression&quot; };
    ($j:literal) =&gt; { &quot;This was a literal&quot; };
}

<span class="boring">fn main() {
</span>let expr1 = ordering!('a');  // =&gt; &quot;This was an expression&quot;.
let expr1 = ordering!(3 + 5);  // =&gt; &quot;This was an expression&quot;.
<span class="boring">}
</span></code></pre></pre>
<p>This example demonstrates an example where rust macros can behave strangely due to
ordering rules -- even though <code>literal</code> is a much stricter condition than <code>expr</code>,
because <code>literal</code>s are <code>expr</code>s; the first rule will always match.</p>
<h2 id="exercise-9-ambiguity-and-ordering-1"><a class="header" href="#exercise-9-ambiguity-and-ordering-1">Exercise 9: Ambiguity and Ordering</a></h2>
<p>This task is a little bit different to previous tasks -- we have given you 
a partially functional macro already; along with some invocations of that macro.</p>
<p>You should adjust the macro's rules and syntax to make sure that you 
achieve the correct behaviour without any ambiguity. </p>
<ul>
<li><code>sum!()</code> should sum together two or more expressions together.</li>
<li><code>get_number_type!()</code> should determine what sort of rust syntax is being used:
a positive literal; a negative literal; a block, or an expression.</li>
</ul>
<p>You may not edit the <code>main</code> function; but it should eventually look like the
following:</p>
<!-- If you can see this text, it means you're not looking at the book.   -->
<!-- Run the cargo command below (without `cmdrun`) to see the real code. -->
<pre><code class="language-rust ignore">fn main() {
    NumberType::PositiveNumber(5).show();
    NumberType::NegativeNumber(-5).show();
    #[allow(clippy::let_and_return)]
    NumberType::UnknownBecauseBlock({
            let x = 6;
            x
        })
        .show();
    NumberType::UnknownBecauseExpr(1 + 2 + 3 + 4).show();
    NumberType::UnknownBecauseExpr(3 + 5 - 1).show();
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="08_README.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="10_README.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="08_README.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="10_README.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
