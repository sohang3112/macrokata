<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>04: Expression Meta-Variables - MacroKata</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">00: Introduction</a></li><li class="chapter-item expanded "><a href="01_README.html">01: My First Macro</a></li><li class="chapter-item expanded "><a href="02_README.html">02: Numbers</a></li><li class="chapter-item expanded "><a href="03_README.html">03: Literal Meta-Variables</a></li><li class="chapter-item expanded "><a href="04_README.html" class="active">04: Expression Meta-Variables</a></li><li class="chapter-item expanded "><a href="05_README.html">05: More Complex Example</a></li><li class="chapter-item expanded "><a href="06_README.html">06: Repetition</a></li><li class="chapter-item expanded "><a href="07_README.html">07: More Repetition</a></li><li class="chapter-item expanded "><a href="08_README.html">08: Nested Repetition</a></li><li class="chapter-item expanded "><a href="09_README.html">09: Ambiguity and Ordering</a></li><li class="chapter-item expanded "><a href="10_README.html">10: Macros Calling Macros</a></li><li class="chapter-item expanded "><a href="11_README.html">11: Macro Recursion</a></li><li class="chapter-item expanded "><a href="12_README.html">12: Macro Hygiene</a></li><li class="chapter-item expanded "><a href="13_README.html">13: Scoping, Importing and Exporting</a></li><li class="chapter-item expanded "><a href="99_README.html">14: Extra Reading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MacroKata</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="exercise-4-expression-metavariables"><a class="header" href="#exercise-4-expression-metavariables">Exercise 4: Expression Metavariables</a></h1>
<p>We can now capture fragments of Rust code that are literals, however there are
other fragments of rust code which can be captured in metavariables. In general,
every metavariable is of the form <code>$&lt;NAME&gt;:&lt;FRAGSPEC&gt;</code>. <code>&lt;NAME&gt;</code> is replaced
with the name of the metavariable; but <code>FRAGSPEC</code> is more interesting. It means
&quot;Fragment Specifier&quot;, and it tells you what sort of fragment of Rust code you
intend to match. We've already seen <code>literal</code>, but another common fragment
specifier is <code>expr</code>, which allows you to capture any rust expression (for
example, <code>(3 * 5)</code> or <code>function_call() + CONSTANT</code>).</p>
<p>Using this specifier is nearly identical to using the <code>literal</code> fragment
specifier -- <code>$x:expr</code> indicates a metavariable, which is an expression, named
<code>x</code>.</p>
<p>It's also worth mentioning the fragment specifier <code>stmt</code>, which is similar to
<code>expr</code>, but allows Rust statements too, like <code>let</code> statements.</p>
<h1 id="macros-and-the-precedence-of-operators"><a class="header" href="#macros-and-the-precedence-of-operators">Macros and the Precedence of Operators</a></h1>
<p>Macros do not affect the order of operations. If the expression <code>3 * math!(4, plus, 2)</code> expands to <code>3 * 4 + 2</code>; the answer will be 14, not 18 (as you might
expect from the brackets).</p>
<h1 id="follow-set-ambiguity-rules"><a class="header" href="#follow-set-ambiguity-rules">&quot;Follow-set Ambiguity Rules&quot;</a></h1>
<p>The rust parser needs to have some way of telling &quot;where does a metavariable
end&quot;. If it didn't, expressions like <code>$first:expr $second:expr</code> would be confusing to
parse in some circumstances (for example, how would you parse <code>a * b * c * d</code>?
Would <code>first</code> be <code>a</code>, and <code>second</code> be <code>*b * c * d</code>? Or would <code>first</code> be <code>a * b * c</code>,
and <code>second</code> be <code>* d</code>?</p>
<p>To avoid this problem entirely, Rust has a set of rules called the &quot;follow-set
ambiguity rules&quot;. These tell you which tokens are allowed to follow a
metavariable (and which aren't).</p>
<p>For <code>literal</code>s, this rule is simple -- anything can follow a literal
metavariable.</p>
<p>For <code>expr</code> (and it's friend <code>stmt</code>) the rules are much more restrictive -- they
can only be followed by <code>=&gt;</code> or <code>,</code> or <code>;</code>.</p>
<p>This means that building a matcher like this:</p>
<pre><code class="language-rust ignore">macro_rules! broken_macro {
    ($a:expr please) =&gt; $a
}

fn main() {
    // Fails to compile!
    let value = broken_macro!(3 + 5 please);
}
</code></pre>
<p>will give you this compiler error:</p>
<pre><code class="language-rust ignore">error: `$a:expr` is followed by `please`, which is not allowed for `expr` fragments
 --&gt; broken_macro.rs:2:14
  |
2 |     ($a:expr please) =&gt; { $a }
  |              ^^^^^^ not allowed after `expr` fragments
  |
  = note: allowed there are: `=&gt;`, `,` or `;`
</code></pre>
<p>As we encounter more expression types, we'll make sure to mention their
follow-set rules; but <a href="https://doc.rust-lang.org/reference/macros-by-example.html#follow-set-ambiguity-restrictions">this page in the Rust
reference</a>
has a comprehensive list of the rules for each fragment specifier type.</p>
<h2 id="exercise-4-expression-variables"><a class="header" href="#exercise-4-expression-variables">Exercise 4: Expression Variables</a></h2>
<p>In this task, you will be completing a similar task to the previous one.
Last time, your macro should have worked with any <em>literal</em>, but now we would
like a macro which works with any <em>expression</em>.</p>
<ul>
<li>The syntax <code>math!(3, plus, (5 + 6))</code> should expand to <code>3 + (5 + 6)</code>, where
<code>3</code> and <code>(5 + 6)</code> could be any expression.</li>
<li>The syntax <code>math!(square my_expression)</code> should expand to <code>my_expression * my_expression</code>, where <code>my_expression</code> could be any expression.</li>
</ul>
<p>You may not edit the <code>main</code> function; but it should eventually look like the
following:</p>
<!-- If you can see this text, it means you're not looking at the book.   -->
<!-- Run the cargo command below (without `cmdrun`) to see the real code. -->
<pre><code class="language-rust ignore">fn main() {
    let var = 5;
    print_result((2 * 3) + var);
    print_result(var * var);
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="03_README.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="05_README.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="03_README.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="05_README.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
